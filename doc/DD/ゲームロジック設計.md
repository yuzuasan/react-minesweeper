## 5. ゲームロジック設計

---

## 5.1 ゲーム初期化処理

### 処理概要
- 難易度設定を元に盤面を生成する
- すべてのマスを未オープン・未フラグ状態に初期化する
- ゲーム状態を `ready` に設定する  
  （ゲーム開始は最初のマス開放時とする）

---

### 実行タイミング
- アプリ起動時
- 難易度変更時
- ゲームリスタート時

---

### 処理手順
1. 盤面サイズ（width / height）を決定
2. 空の盤面（Cell 配列）を生成
3. 地雷をランダムに配置
4. 各マスの周囲地雷数を計算
5. board state を更新
6. gameStatus を `ready` に設定
7. remainingMines を初期化（mineCount）
8. elapsedTime をリセット（0）

---

## 5.2 地雷配置ロジック

### 要件
- 地雷数は難易度設定に従う
- 同じマスに複数の地雷を配置しない
- 完全ランダムで配置する

---

### 処理方針
- 乱数で座標を生成する
- すでに地雷が配置されている場合は再抽選する
- 指定された地雷数に達するまで繰り返す

---

### 擬似コード

```ts
while (placedMines < mineCount) {
  const x = random(0, width - 1);
  const y = random(0, height - 1);

  if (!cells[y][x].isMine) {
    cells[y][x].isMine = true;
    placedMines++;
  }
}
````

---

## 5.3 周囲地雷数計算ロジック

### 対象

* 地雷ではないすべてのマス

---

### 処理方針

* 各マスの周囲8マスを確認する
* 地雷の数をカウントする
* カウント結果を `adjacentMines` に設定する

---

### 擬似コード

```ts
for each cell {
  if (cell.isMine) continue;

  count = 0;
  for each neighbor {
    if (neighbor.isMine) count++;
  }
  cell.adjacentMines = count;
}
```

---

## 5.4 マス開放ロジック

### 通常開放処理

#### 条件

* 未オープンである
* 旗が立っていない

---

#### 処理内容

1. **最初のマス開放時（gameStatus === `ready`）**

   * タイマーを開始する
   * gameStatus を `playing` に変更する
2. マスを開く
3. 地雷マスの場合

   * ゲームオーバー処理を実行する
4. 地雷でない場合

   * 周囲地雷数を表示する
   * `adjacentMines === 0` の場合、連鎖開放処理を行う

---

### 連鎖開放処理

* 周囲のマスを再帰的またはスタックを用いて開放する
* すでに開いているマス、旗が立っているマスは対象外とする

---

### 擬似コード

```ts
function openCell(x, y) {
  if (gameStatus === 'ready') {
    startTimer();
    setGameStatus('playing');
  }

  const cell = cells[y][x];
  if (cell.isOpen || cell.isFlagged) return;

  cell.isOpen = true;

  if (cell.isMine) {
    gameOver();
    return;
  }

  if (cell.adjacentMines === 0) {
    for each neighbor {
      openCell(neighbor.x, neighbor.y);
    }
  }
}
```

---

## 5.5 旗設置・解除ロジック

### 操作仕様

* 未オープンのマスのみ操作可能
* 旗の ON / OFF を切り替える
* 旗の設置数は地雷数を上限とする

---

### 処理内容

* 旗を立てる場合

  * `remainingMines > 0` の場合のみ許可する
* 旗を外す場合

  * 常に許可する
* `isFlagged` をトグルする
* `remainingMines` を増減する

---

### 擬似コード

```ts
if (cell.isOpen) return;

if (!cell.isFlagged && remainingMines === 0) return;

cell.isFlagged = !cell.isFlagged;
remainingMines += cell.isFlagged ? -1 : 1;
```

---

## 5.6 ゲームオーバー判定

### 判定条件

* 地雷マスを開いた場合

---

### 処理内容

* gameStatus を `gameover` に変更する
* タイマーを停止する
* すべての地雷マスを表示する
* 盤面操作を無効化する
* ゲームオーバー結果を表示する

---

## 5.7 クリア判定ロジック

### 判定条件

* 地雷以外のすべてのマスが開かれていること

---

### 判定方法

```ts
if (openedCells === width * height - mineCount) {
  gameClear();
}
```

---

## 5.8 ゲーム終了時処理

### 共通処理

* タイマーを停止する
* 盤面への操作を無効化する

---

### クリア時

* gameStatus を `clear` に変更する
* ハイスコア更新判定を行う
* クリア結果を表示する

---

### ゲームオーバー時

* gameStatus を `gameover` に変更する
* ゲームオーバー結果を表示する
